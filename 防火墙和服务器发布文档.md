# 防火墙配置和服务器发布文档

## 一、防火墙配置

### 1.1 CentOS 7 (firewalld)

#### 查看防火墙状态
```bash
sudo systemctl status firewalld
```

#### 启动/停止防火墙
```bash
# 启动防火墙
sudo systemctl start firewalld

# 停止防火墙
sudo systemctl stop firewalld

# 开机自启
sudo systemctl enable firewalld
```

#### 开放端口（本项目所需）
```bash
# MySQL数据库
sudo firewall-cmd --permanent --add-port=3306/tcp

# Java Spring Boot后端
sudo firewall-cmd --permanent --add-port=8080/tcp

# Vue 前端开发服务器（开发环境）
sudo firewall-cmd --permanent --add-port=8081/tcp

# Python Flask服务（可选，已弃用）
# sudo firewall-cmd --permanent --add-port=5000/tcp

# Nginx前端（生产环境）
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp

# Hadoop相关端口（如果Hadoop在同一服务器）
sudo firewall-cmd --permanent --add-port=9000/tcp    # NameNode
sudo firewall-cmd --permanent --add-port=50070/tcp   # NameNode Web UI
sudo firewall-cmd --permanent --add-port=50090/tcp   # SecondaryNameNode
sudo firewall-cmd --permanent --add-port=50010/tcp    # DataNode
sudo firewall-cmd --permanent --add-port=50020/tcp    # DataNode IPC
sudo firewall-cmd --permanent --add-port=8032/tcp     # ResourceManager
sudo firewall-cmd --permanent --add-port=8088/tcp     # ResourceManager Web UI

# SSH（确保SSH端口开放）
sudo firewall-cmd --permanent --add-port=22/tcp

# 重新加载防火墙规则
sudo firewall-cmd --reload

# 查看已开放的端口
sudo firewall-cmd --list-ports
```

#### 配置防火墙规则（允许特定IP）
```bash
# 允许特定IP访问8080端口
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.1.0/24" port port="8080" protocol="tcp" accept'

# 重新加载
sudo firewall-cmd --reload
```

### 1.2 Ubuntu (ufw)

```bash
# 开放端口
sudo ufw allow 3306/tcp    # MySQL
sudo ufw allow 8080/tcp    # Java后端
sudo ufw allow 8081/tcp    # Vue 前端开发服务器
# sudo ufw allow 5000/tcp  # Python服务（可选，已弃用）
sudo ufw allow 80/tcp      # HTTP
sudo ufw allow 443/tcp     # HTTPS
sudo ufw allow 22/tcp      # SSH

# 查看防火墙状态
sudo ufw status

# 查看详细规则
sudo ufw status verbose
```

### 1.3 临时关闭防火墙（仅用于测试）
```bash
# CentOS 7
sudo systemctl stop firewalld

# Ubuntu
sudo ufw disable
```

## 二、数据库配置

### 2.1 MySQL/MariaDB配置
```bash
# 允许远程连接（开发环境）
sudo vi /etc/mysql/mariadb.conf.d/50-server.cnf
# 或
sudo vi /etc/my.cnf.d/mariadb-server.cnf

# 找到 bind-address，修改为：
bind-address = 0.0.0.0

# 重启MySQL
sudo systemctl restart mariadb
```

### 2.2 导入数据库
```bash
# 登录MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE pigms CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 退出，导入SQL文件
mysql -u root -p pigms < /path/to/pigms.sql
mysql -u root -p pigms < /path/to/pigms_extension.sql

# 验证
mysql -u root -p -e "USE pigms; SHOW TABLES;"
```

## 三、Java后端服务部署

### 3.1 构建项目
```bash
# 进入Java项目目录
cd /opt/pig-system/javaPart/pigms

# 清理并打包
mvn clean package -DskipTests

# 生成的jar包位置：target/pigms-0.0.1-SNAPSHOT.jar
```

### 3.2 配置文件准备
```bash
# 复制配置文件到部署目录
mkdir -p /opt/pig-system/deploy
cp target/pigms-0.0.1-SNAPSHOT.jar /opt/pig-system/deploy/

# 创建外部配置文件（可选，覆盖application.yml中的配置）
vi /opt/pig-system/deploy/application-prod.yml
```

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/pigms?useUnicode=true&characterEncoding=utf-8&useSSL=false
    username: root
    password: your_password

hadoop:
  namenode: hdfs://192.168.100.10:9000
  resourcemanager: 192.168.100.10:8032
  user: hadoop
```

> **注意**: 预测功能已迁移到前端实现，无需配置 Python 服务 URL。

### 3.3 启动Java服务
```bash
# 方式1：前台运行（测试用）
cd /opt/pig-system/deploy
java -jar -Dspring.profiles.active=prod pigms-0.0.1-SNAPSHOT.jar

# 方式2：后台运行
nohup java -jar -Dspring.profiles.active=prod pigms-0.0.1-SNAPSHOT.jar > /opt/pig-system/logs/java.log 2>&1 &

# 查看日志
tail -f /opt/pig-system/logs/java.log
```

### 3.4 使用systemd管理（推荐）
```bash
# 创建服务文件
sudo vi /etc/systemd/system/pig-backend.service
```

```
[Unit]
Description=Pig System Backend Service
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/pig-system/deploy
ExecStart=/opt/jdk1.8/bin/java -jar -Dspring.profiles.active=prod /opt/pig-system/deploy/pigms-0.0.1-SNAPSHOT.jar
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

```bash
# 重载systemd配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start pig-backend

# 开机自启
sudo systemctl enable pig-backend

# 查看状态
sudo systemctl status pig-backend

# 查看日志
sudo journalctl -u pig-backend -f
```

## 四、Python服务部署（可选，已弃用）

> **注意**: 预测算法已迁移到前端 JavaScript 实现，通常无需部署 Python 服务。以下步骤仅供需要使用 Python 服务的情况参考。

### 4.1 安装依赖
```bash
cd /opt/pig-system/pythonService

# 安装Python依赖
pip3 install -r requirements.txt

# 如果requirements.txt不存在，手动安装
pip3 install flask flask-cors numpy scikit-learn joblib
```

### 4.2 启动Python服务
```bash
# 方式1：前台运行（测试）
cd /opt/pig-system/pythonService
python3 app.py

# 方式2：后台运行
nohup python3 app.py > /opt/pig-system/logs/python.log 2>&1 &

# 查看日志
tail -f /opt/pig-system/logs/python.log
```

### 4.3 使用systemd管理
```bash
sudo vi /etc/systemd/system/pig-python.service
```

```
[Unit]
Description=Pig System Python Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/pig-system/pythonService
ExecStart=/usr/bin/python3 /opt/pig-system/pythonService/app.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl daemon-reload
sudo systemctl start pig-python
sudo systemctl enable pig-python
sudo systemctl status pig-python
```

## 五、前端部署

### 5.1 构建前端项目
```bash
cd /opt/pig-system/viewPart/pig-msys

# 安装依赖（首次）
npm install

# 构建生产版本
npm run build

# 构建后的文件在 dist/ 目录
```

### 5.2 使用Nginx部署（推荐）

#### 安装Nginx
```bash
# CentOS 7
sudo yum install -y nginx

# Ubuntu
sudo apt install -y nginx
```

#### 配置Nginx
```bash
sudo vi /etc/nginx/conf.d/pig-system.conf
```

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 或使用IP地址

    root /opt/pig-system/viewPart/pig-msys/dist;
    index index.html;

    # 前端静态文件
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 后端API代理
    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Python服务代理
    location /predict {
        proxy_pass http://localhost:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

```bash
# 测试配置
sudo nginx -t

# 启动Nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# 重启Nginx（修改配置后）
sudo systemctl restart nginx
```

### 5.3 直接使用Node.js运行（开发模式，不推荐生产）
```bash
cd /opt/pig-system/viewPart/pig-msys
npm run serve -- --host 0.0.0.0 --port 8081
```

## 六、服务启动顺序

```bash
# 1. 启动数据库
sudo systemctl start mariadb

# 2. 启动Hadoop（如果在本机且需要大数据分析功能）
# 切换到hadoop用户
su - hadoop
start-all.sh
exit

# 3. 启动Java后端
sudo systemctl start pig-backend

# 4. （可选）启动Python服务（已弃用，通常不需要）
# sudo systemctl start pig-python

# 5. 启动Nginx（生产环境）
sudo systemctl start nginx
```

## 七、服务状态检查

### 7.1 检查各服务状态
```bash
# 检查所有服务
sudo systemctl status mariadb
sudo systemctl status pig-backend
sudo systemctl status nginx
# sudo systemctl status pig-python  # 可选，如果使用

# 检查端口占用
sudo netstat -tlnp | grep -E '3306|8080|80'

# 或使用ss命令
sudo ss -tlnp | grep -E '3306|8080|80'
```

### 7.2 检查服务健康
```bash
# Java后端健康检查
curl http://localhost:8080/api/health

# 前端访问
curl http://localhost/

# Python服务健康检查（可选，如果使用）
# curl http://localhost:5000/health
```

## 八、日志查看

```bash
# Java后端日志
tail -f /opt/pig-system/logs/java.log
# 或
sudo journalctl -u pig-backend -f

# Python服务日志
tail -f /opt/pig-system/logs/python.log
# 或
sudo journalctl -u pig-python -f

# Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# MySQL日志
sudo tail -f /var/log/mariadb/mariadb.log
```

## 九、服务更新流程

### 9.1 更新Java后端
```bash
# 1. 停止服务
sudo systemctl stop pig-backend

# 2. 备份旧版本
cp /opt/pig-system/deploy/pigms-0.0.1-SNAPSHOT.jar /opt/pig-system/deploy/backup/

# 3. 构建新版本
cd /opt/pig-system/javaPart/pigms
mvn clean package -DskipTests

# 4. 复制新jar包
cp target/pigms-0.0.1-SNAPSHOT.jar /opt/pig-system/deploy/

# 5. 启动服务
sudo systemctl start pig-backend

# 6. 检查状态
sudo systemctl status pig-backend
```

### 9.2 更新前端
```bash
# 1. 构建新版本
cd /opt/pig-system/viewPart/pig-msys
npm run build

# 2. 备份旧版本（可选）
cp -r dist /opt/pig-system/backup/dist-$(date +%Y%m%d)

# 3. 新文件已在dist目录，重启Nginx
sudo systemctl restart nginx
```

### 9.3 更新Python服务
```bash
# 1. 停止服务
sudo systemctl stop pig-python

# 2. 更新代码（如果是git仓库）
cd /opt/pig-system/pythonService
git pull

# 3. 更新依赖（如有新增）
pip3 install -r requirements.txt

# 4. 启动服务
sudo systemctl start pig-python
```

## 十、故障排查

### 10.1 服务无法启动
```bash
# 查看详细错误信息
sudo journalctl -u pig-backend -n 50
sudo journalctl -u pig-python -n 50

# 检查端口是否被占用
sudo lsof -i :8080
sudo lsof -i :5000
```

### 10.2 无法访问服务
```bash
# 检查防火墙
sudo firewall-cmd --list-ports

# 检查服务是否运行
sudo systemctl status pig-backend

# 检查网络连接
curl http://localhost:8080
```

### 10.3 数据库连接失败
```bash
# 检查MySQL服务
sudo systemctl status mariadb

# 测试连接
mysql -u root -p -h localhost

# 检查配置文件中的数据库地址和密码
```

## 十一、安全检查建议

1. **修改默认密码**：修改MySQL root密码和应用配置中的密码
2. **限制访问**：生产环境建议配置防火墙只允许特定IP访问
3. **定期备份**：定期备份数据库和重要文件
4. **监控日志**：定期检查日志文件，发现异常及时处理
5. **使用HTTPS**：生产环境建议配置SSL证书

---

